<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provably Fair Coin Flip</title>
</head>
<body>
    <h1>Provably Fair Coin Flip</h1>
    <button onclick="flipCoin('heads')">Heads</button>
    <button onclick="flipCoin('tails')">Tails</button>
    <p id="result"></p>
    <script>
        let serverHash = '';

        fetch('/get_hash')
            .then(response => response.json())
            .then(data => {
                serverHash = data.hash;
                console.log('Server Hash:', serverHash);
            });

        function flipCoin(choice) {
            fetch('/reveal')
                .then(response => response.json())
                .then(data => {
                    const { secret_seed, nonce } = data;
                    const serverSeed = secret_seed + nonce;
                    const clientHash = sha256(serverSeed);
                    
                    if (clientHash === serverHash) {
                        const coinResult = (parseInt(secret_seed) + parseInt(nonce)) % 2 === 0 ? 'heads' : 'tails';
                        const result = coinResult === choice ? 'You win!' : 'You lose!';
                        document.getElementById('result').innerText = result;
                    } else {
                        document.getElementById('result').innerText = 'Hash verification failed!';
                    }
                });
        }

        function sha256(message) {
            const msgBuffer = new TextEncoder('utf-8').encode(message);
            return crypto.subtle.digest('SHA-256', msgBuffer).then(hashBuffer => {
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            });
        }
    </script>
</body>
</html>
